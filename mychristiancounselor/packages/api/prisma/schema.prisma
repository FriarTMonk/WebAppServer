generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User account
model User {
  id                String              @id @default(uuid())
  email             String              @unique
  passwordHash      String
  firstName         String?
  lastName          String?
  emailVerified     Boolean             @default(false)
  verificationToken String?             @unique
  resetToken        String?             @unique
  resetTokenExpiry  DateTime?
  isActive          Boolean             @default(true)
  accountType       String              @default("individual") // 'individual' or 'organization'
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  // Relations
  refreshTokens     RefreshToken[]
  sessions          Session[]
  organizationMemberships OrganizationMember[]
  invitationsCreated OrganizationInvitation[] @relation("CreatedByUser")
  invitationsReceived OrganizationInvitation[] @relation("InvitedUser")
  adminActionsGiven AdminAuditLog[]     @relation("AdminActions")
  adminActionsReceived AdminAuditLog[]  @relation("ActionsReceived")

  @@index([email])
  @@index([verificationToken])
  @@index([resetToken])
  @@index([accountType])
}

// JWT refresh tokens (server-side storage)
model RefreshToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  ipAddress String?
  userAgent String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}

// Organization (church, ministry, counseling center)
model Organization {
  id                String    @id @default(uuid())
  name              String
  description       String?   @db.Text
  licenseType       String?   // 'Family', 'Small', 'Medium', 'Large'
  licenseStatus     String    @default("trial") // 'trial', 'active', 'expired', 'cancelled'
  licenseExpiresAt  DateTime?
  maxMembers        Int       @default(10)
  isSystemOrganization Boolean @default(false) // true for Platform Admin org
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  members           OrganizationMember[]
  invitations       OrganizationInvitation[]
  roles             OrganizationRole[]
  auditLogs         AdminAuditLog[]
  metricSnapshots   MetricSnapshot[]

  @@index([licenseStatus])
  @@index([licenseExpiresAt])
  @@index([isSystemOrganization])
}

// User membership in organization
model OrganizationMember {
  id             String       @id @default(uuid())
  organizationId String
  userId         String
  roleId         String
  joinedAt       DateTime     @default(now())

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  role           OrganizationRole @relation(fields: [roleId], references: [id], onDelete: Restrict)

  @@unique([organizationId, userId])
  @@index([organizationId])
  @@index([userId])
}

// Flexible role system
model OrganizationRole {
  id             String       @id @default(uuid())
  organizationId String
  name           String       // 'Owner', 'Counselor', 'Member', or custom
  description    String?
  isSystemRole   Boolean      @default(false) // true for Owner, Counselor, Member
  permissions    Json         @default("[]") // Array of permission strings
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  members        OrganizationMember[]

  @@unique([organizationId, name])
  @@index([organizationId])
}

// Organization invitations
model OrganizationInvitation {
  id             String       @id @default(uuid())
  organizationId String
  email          String
  roleId         String
  invitedById    String
  token          String       @unique
  status         String       @default("pending") // 'pending', 'accepted', 'expired', 'cancelled'
  expiresAt      DateTime
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  invitedBy      User         @relation("CreatedByUser", fields: [invitedById], references: [id], onDelete: Cascade)
  acceptedBy     User?        @relation("InvitedUser", fields: [acceptedById], references: [id], onDelete: SetNull)
  acceptedById   String?

  @@index([organizationId])
  @@index([email])
  @@index([token])
  @@index([status])
  @@index([expiresAt])
}

// Admin audit log for morphing and sensitive operations
model AdminAuditLog {
  id                String   @id @default(uuid())
  adminUserId       String   // The platform admin performing action
  action            String   // 'morph_start', 'morph_end', 'update_license', 'delete_user', etc.
  targetUserId      String?  // User being acted upon (if applicable)
  targetOrgId       String?  // Organization being acted upon (if applicable)
  morphSessionId    String?  // Links all actions during a morph session
  metadata          Json     @default("{}") // Additional context (IP, changes made, etc.)
  createdAt         DateTime @default(now())

  adminUser         User     @relation("AdminActions", fields: [adminUserId], references: [id])
  targetUser        User?    @relation("ActionsReceived", fields: [targetUserId], references: [id])
  targetOrg         Organization? @relation(fields: [targetOrgId], references: [id])

  @@index([adminUserId])
  @@index([morphSessionId])
  @@index([action])
  @@index([createdAt])
}

// Pre-aggregated metrics (computed by background job)
model MetricSnapshot {
  id              String   @id @default(uuid())
  snapshotType    String   // 'daily', 'weekly', 'monthly'
  snapshotDate    DateTime // Date this snapshot represents
  organizationId  String?  // null for platform-wide metrics
  metrics         Json     // Flexible JSON containing all computed metrics
  createdAt       DateTime @default(now())

  organization    Organization? @relation(fields: [organizationId], references: [id])

  @@unique([snapshotType, snapshotDate, organizationId])
  @@index([snapshotDate])
  @@index([organizationId])
}

model Session {
  id                    String    @id @default(uuid())
  userId                String?   // null for anonymous users
  title                 String
  status                String    @default("active") // 'active' | 'completed'
  preferredTranslation  String    @default("ASV") // Bible translation preference (KJV or ASV)
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  messages              Message[]

  user                  User?     @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([createdAt])
  @@index([userId])
}

model Message {
  id                       String   @id @default(uuid())
  sessionId                String
  role                     String   // 'user' | 'assistant' | 'system'
  content                  String   @db.Text
  scriptureReferences      Json     @default("[]")
  constitutionalReferences Json     @default("[]")
  timestamp                DateTime @default(now())

  session                  Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([timestamp])
}

// Bible Translation metadata
model BibleTranslation {
  code        String        @id @unique // 'KJV', 'ASV'
  name        String        // Short name
  fullName    String        // Full name
  description String?       @db.Text
  isActive    Boolean       @default(true)
  createdAt   DateTime      @default(now())

  verses      BibleVerse[]

  @@index([isActive])
}

// Individual Bible verses across all translations
model BibleVerse {
  id               String            @id @default(uuid())
  translationCode  String            // Foreign key to BibleTranslation
  book             String            // e.g., 'John', 'Genesis'
  chapter          Int
  verse            Int
  text             String            @db.Text
  strongs          Json?             @default("[]") // Array of Strong's number annotations

  translation      BibleTranslation  @relation(fields: [translationCode], references: [code], onDelete: Cascade)

  // Ensure no duplicate verses per translation
  @@unique([translationCode, book, chapter, verse])

  // Optimize verse lookups
  @@index([translationCode, book, chapter, verse])
  @@index([book])
}
