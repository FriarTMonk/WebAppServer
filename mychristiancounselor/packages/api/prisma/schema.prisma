generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                        String                   @id @default(uuid())
  email                     String                   @unique
  passwordHash              String
  firstName                 String?
  lastName                  String?
  emailVerified             Boolean                  @default(false)
  verificationToken         String?                  @unique
  resetToken                String?                  @unique
  resetTokenExpiry          DateTime?
  isActive                  Boolean                  @default(true)
  createdAt                 DateTime                 @default(now())
  updatedAt                 DateTime                 @updatedAt
  accountType               String                   @default("individual")
  isPlatformAdmin           Boolean                  @default(false)
  comparisonTranslations    String[]                 @default(["ESV", "NASB", "NIV", "NKJV"])
  preferredTranslation      String?                  @default("KJV")
  stripeCustomerId          String?                  @unique
  subscriptionEnd           DateTime?
  subscriptionStart         DateTime?
  subscriptionStatus        String                   @default("none")
  subscriptionTier          String?
  birthDate                 DateTime?
  completedTours            String[]                 @default([])
  deletionRequestedAt       DateTime?
  deletionRequestedBy       String?
  isSalesRep                Boolean                  @default(false)
  verificationTokenExpiry   DateTime?
  adminActionsGiven         AdminAuditLog[]          @relation("AdminActions")
  adminActionsReceived      AdminAuditLog[]          @relation("ActionsReceived")
  booksSubmitted            Book[]                   @relation("BooksSubmitted")
  bookEndorsements          BookEndorsement[]        @relation("BookEndorsements")
  counselorAssignments      CounselorAssignment[]    @relation("CounselorAssignments")
  memberAssignments         CounselorAssignment[]    @relation("MemberAssignments")
  coverageGrantsReceived    CounselorCoverageGrant[] @relation("CoverageGrantsReceived")
  coverageGrantsForMember   CounselorCoverageGrant[] @relation("CoverageGrantsForMember")
  coverageGrantsGiven       CounselorCoverageGrant[] @relation("CoverageGrantsGiven")
  observationsAuthored      CounselorObservation[]   @relation("ObservationsAuthored")
  observationsReceived      CounselorObservation[]   @relation("ObservationsReceived")
  holidaysCreated           Holiday[]                @relation("HolidaysCreated")
  wellbeingStatus           MemberWellbeingStatus?
  notificationsReceived     Notification[]           @relation("NotificationsReceived")
  notificationsSent         Notification[]           @relation("NotificationsSent")
  invitationsReceived       OrganizationInvitation[] @relation("InvitedUser")
  invitationsCreated        OrganizationInvitation[] @relation("CreatedByUser")
  organizationMemberships   OrganizationMember[]
  refreshTokens             RefreshToken[]
  salesActivitiesPerformed  SalesActivity[]          @relation("SalesActivitiesPerformed")
  salesNotesAuthored        SalesNote[]              @relation("SalesNotesAuthored")
  opportunitiesAssigned     SalesOpportunity[]       @relation("OpportunitiesAssigned")
  opportunitiesCreated      SalesOpportunity[]       @relation("OpportunitiesCreated")
  sessions                  Session[]
  sessionNotesAuthored      SessionNote[]            @relation("SessionNotesAuthored")
  subscriptions             Subscription[]
  externalOrgsAdded         ExternalOrganization[]   @relation("ExternalOrgsAdded")
  readingLists              UserReadingList[]        @relation("ReadingLists")
  ticketsAssigned           SupportTicket[]          @relation("TicketsAssigned")
  ticketsClosed             SupportTicket[]          @relation("TicketsClosed")
  ticketsCreated            SupportTicket[]          @relation("TicketsCreated")
  ticketsResolved           SupportTicket[]          @relation("TicketsResolved")
  ticketAttachmentsUploaded TicketAttachment[]       @relation("TicketAttachmentsUploaded")
  ticketLinksCreated        TicketLink[]             @relation("TicketLinksCreated")
  ticketMessagesAuthored    TicketMessage[]          @relation("TicketMessagesAuthored")
  prospectsCreated          Prospect[]               @relation("ProspectsCreated")
  campaignsCreated          EmailCampaign[]          @relation("CampaignsCreated")

  @@index([email])
  @@index([verificationToken])
  @@index([resetToken])
  @@index([accountType])
  @@index([isPlatformAdmin])
  @@index([isSalesRep])
  @@index([subscriptionStatus])
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  ipAddress String?
  userAgent String?
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@index([createdAt])
}

model Organization {
  id                                String                   @id @default(uuid())
  name                              String
  description                       String?
  specialtyTags                     String[]                 @default([])
  website                           String?
  organizationAddressId             String?
  organizationAddress               OrganizationAddress?     @relation(fields: [organizationAddressId], references: [id])
  licenseType                       String?
  licenseStatus                     String                   @default("trial")
  licenseExpiresAt                  DateTime?
  maxMembers                        Int                      @default(10)
  createdAt                         DateTime                 @default(now())
  updatedAt                         DateTime                 @updatedAt
  isSystemOrganization              Boolean                  @default(false)
  archivedAt                        DateTime?
  matureContentAccountTypeThreshold String?                  @default("teen")
  offersVirtualServices             Boolean                  @default(false)
  auditLogs                         AdminAuditLog[]
  booksSubmitted                    Book[]                   @relation("BooksSubmittedByOrg")
  bookEndorsements                  BookEndorsement[]
  counselorAssignments              CounselorAssignment[]
  metricSnapshots                   MetricSnapshot[]
  contract                          OrganizationContract?
  invitations                       OrganizationInvitation[]
  members                           OrganizationMember[]
  roles                             OrganizationRole[]
  salesOpportunities                SalesOpportunity[]
  supportTickets                    SupportTicket[]
  externalOrgsRecommended           ExternalOrganization[]   @relation("ExternalOrgsRecommended")
  prospectsConverted                Prospect[]               @relation("ProspectConversions")

  @@index([licenseStatus])
  @@index([licenseExpiresAt])
  @@index([isSystemOrganization])
  @@index([organizationAddressId])
}

model OrganizationMember {
  id             String           @id @default(uuid())
  organizationId String
  userId         String
  roleId         String
  joinedAt       DateTime         @default(now())
  organization   Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  role           OrganizationRole @relation(fields: [roleId], references: [id])
  user           User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@index([organizationId])
  @@index([userId])
}

model OrganizationRole {
  id             String               @id @default(uuid())
  organizationId String
  name           String
  description    String?
  isSystemRole   Boolean              @default(false)
  permissions    Json                 @default("[]")
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt
  members        OrganizationMember[]
  organization   Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, name])
  @@index([organizationId])
}

model OrganizationInvitation {
  id             String       @id @default(uuid())
  organizationId String
  email          String
  roleId         String
  invitedById    String
  token          String       @unique
  status         String       @default("pending")
  expiresAt      DateTime
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  acceptedById   String?
  acceptedBy     User?        @relation("InvitedUser", fields: [acceptedById], references: [id])
  invitedBy      User         @relation("CreatedByUser", fields: [invitedById], references: [id], onDelete: Cascade)
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([email])
  @@index([token])
  @@index([status])
  @@index([expiresAt])
}

model AdminAuditLog {
  id             String        @id @default(uuid())
  adminUserId    String
  action         String
  targetUserId   String?
  targetOrgId    String?
  morphSessionId String?
  metadata       Json          @default("{}")
  createdAt      DateTime      @default(now())
  adminUser      User          @relation("AdminActions", fields: [adminUserId], references: [id])
  targetOrg      Organization? @relation(fields: [targetOrgId], references: [id])
  targetUser     User?         @relation("ActionsReceived", fields: [targetUserId], references: [id])

  @@index([adminUserId])
  @@index([morphSessionId])
  @@index([action])
  @@index([createdAt])
}

model MetricSnapshot {
  id             String        @id @default(uuid())
  snapshotType   String
  snapshotDate   DateTime
  organizationId String?
  metrics        Json
  createdAt      DateTime      @default(now())
  organization   Organization? @relation(fields: [organizationId], references: [id])

  @@unique([snapshotType, snapshotDate, organizationId])
  @@index([snapshotDate])
  @@index([organizationId])
}

model Session {
  id                   String         @id @default(uuid())
  userId               String?
  title                String
  status               String         @default("active")
  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt
  preferredTranslation String         @default("ASV")
  topics               Json           @default("[]")
  archivedAt           DateTime?
  deletedAt            DateTime?
  questionCount        Int            @default(0)
  messages             Message[]
  user                 User?          @relation(fields: [userId], references: [id])
  notes                SessionNote[]
  shares               SessionShare[]

  @@index([createdAt])
  @@index([userId])
  @@index([status])
}

model Message {
  id                       String   @id @default(uuid())
  sessionId                String
  role                     String
  content                  String
  scriptureReferences      Json     @default("[]")
  constitutionalReferences Json     @default("[]")
  timestamp                DateTime @default(now())
  isClarifyingQuestion     Boolean  @default(false)
  crisisResources          Json?
  griefResources           Json?
  session                  Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([timestamp])
}

model SessionNote {
  id         String    @id @default(uuid())
  sessionId  String
  authorId   String
  authorName String
  authorRole String
  content    String
  isPrivate  Boolean   @default(false)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  deletedAt  DateTime?
  author     User      @relation("SessionNotesAuthored", fields: [authorId], references: [id], onDelete: Cascade)
  session    Session   @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([authorId])
  @@index([createdAt])
  @@index([deletedAt])
}

model BibleTranslation {
  code        String       @id @unique
  name        String
  fullName    String
  description String?
  isActive    Boolean      @default(true)
  createdAt   DateTime     @default(now())
  verses      BibleVerse[]

  @@index([isActive])
}

model BibleVerse {
  id              String           @id @default(uuid())
  translationCode String
  book            String
  chapter         Int
  verse           Int
  text            String
  strongs         Json?            @default("[]")
  translation     BibleTranslation @relation(fields: [translationCode], references: [code], onDelete: Cascade)

  @@unique([translationCode, book, chapter, verse])
  @@index([translationCode, book, chapter, verse])
  @@index([book])
}

model Subscription {
  id                   String    @id @default(uuid())
  userId               String
  status               String
  tier                 String    @default("basic")
  startDate            DateTime  @default(now())
  endDate              DateTime?
  stripeSubscriptionId String?   @unique
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  user                 User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
}

model SessionShare {
  id               String               @id @default(uuid())
  sessionId        String
  shareToken       String               @unique
  sharedBy         String
  sharedWith       String?
  organizationId   String?
  createdAt        DateTime             @default(now())
  expiresAt        DateTime?
  allowNotesAccess Boolean              @default(false)
  session          Session              @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  accesses         SessionShareAccess[]

  @@index([sessionId])
  @@index([shareToken])
}

model SessionShareAccess {
  id              String       @id @default(uuid())
  shareId         String
  userId          String
  firstAccessedAt DateTime     @default(now())
  lastAccessedAt  DateTime     @default(now())
  isDismissed     Boolean      @default(false)
  dismissedAt     DateTime?
  share           SessionShare @relation(fields: [shareId], references: [id], onDelete: Cascade)

  @@unique([shareId, userId])
  @@index([userId])
  @@index([shareId])
  @@index([isDismissed])
}

model CounselorAssignment {
  id             String       @id @default(uuid())
  counselorId    String
  memberId       String
  organizationId String
  status         String       @default("active")
  assignedBy     String
  assignedAt     DateTime     @default(now())
  endedAt        DateTime?
  counselor      User         @relation("CounselorAssignments", fields: [counselorId], references: [id], onDelete: Cascade)
  member         User         @relation("MemberAssignments", fields: [memberId], references: [id], onDelete: Cascade)
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([counselorId, memberId, organizationId])
  @@index([counselorId, status])
  @@index([memberId])
  @@index([organizationId])
}

model CounselorObservation {
  id          String    @id @default(uuid())
  counselorId String
  memberId    String
  content     String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  counselor   User      @relation("ObservationsAuthored", fields: [counselorId], references: [id], onDelete: Cascade)
  member      User      @relation("ObservationsReceived", fields: [memberId], references: [id], onDelete: Cascade)

  @@index([counselorId, memberId])
  @@index([createdAt])
  @@index([deletedAt])
}

model CounselorCoverageGrant {
  id                 String    @id @default(uuid())
  primaryCounselorId String
  backupCounselorId  String
  memberId           String
  grantedAt          DateTime  @default(now())
  expiresAt          DateTime?
  revokedAt          DateTime?
  backupCounselor    User      @relation("CoverageGrantsReceived", fields: [backupCounselorId], references: [id], onDelete: Cascade)
  member             User      @relation("CoverageGrantsForMember", fields: [memberId], references: [id], onDelete: Cascade)
  primaryCounselor   User      @relation("CoverageGrantsGiven", fields: [primaryCounselorId], references: [id], onDelete: Cascade)

  @@index([backupCounselorId, revokedAt])
  @@index([primaryCounselorId])
  @@index([memberId])
}

model MemberWellbeingStatus {
  id                String   @id @default(uuid())
  memberId          String   @unique
  status            String
  aiSuggestedStatus String
  overriddenBy      String?
  summary           String
  lastAnalyzedAt    DateTime @default(now())
  updatedAt         DateTime @updatedAt
  member            User     @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([lastAnalyzedAt])
}

model Notification {
  id          String    @id @default(uuid())
  recipientId String
  senderId    String?
  type        String
  category    String
  title       String
  message     String
  linkTo      String?
  isRead      Boolean   @default(false)
  isDismissed Boolean   @default(false)
  createdAt   DateTime  @default(now())
  expiresAt   DateTime?
  recipient   User      @relation("NotificationsReceived", fields: [recipientId], references: [id], onDelete: Cascade)
  sender      User?     @relation("NotificationsSent", fields: [senderId], references: [id], onDelete: Cascade)

  @@index([recipientId, isRead, isDismissed])
  @@index([createdAt])
  @@index([recipientId, createdAt])
}

model EmailLog {
  id                String                  @id @default(uuid())
  userId            String?
  recipientEmail    String
  emailType         String
  postmarkId        String?                 @unique
  status            String
  bounceReason      String?
  metadata          Json                    @default("{}")
  sentAt            DateTime                @default(now())
  deliveredAt       DateTime?
  openedAt          DateTime?
  clickedAt         DateTime?
  bouncedAt         DateTime?
  campaignRecipient EmailCampaignRecipient?

  @@index([userId])
  @@index([recipientEmail])
  @@index([emailType])
  @@index([status])
  @@index([sentAt])
  @@index([postmarkId])
}

model EmailRateLimit {
  id             String   @id @default(uuid())
  identifier     String
  identifierType String
  operation      String
  attemptCount   Int      @default(1)
  windowStart    DateTime @default(now())
  expiresAt      DateTime

  @@unique([identifier, identifierType, operation])
  @@index([identifier, operation])
  @@index([expiresAt])
}

model Prospect {
  id                        String                   @id @default(uuid())
  organizationName          String
  website                   String?
  industry                  String?
  estimatedSize             String?
  notes                     String?                  @db.Text
  lastCampaignSentAt        DateTime?
  convertedToOrganizationId String?
  convertedToOrganization   Organization?            @relation("ProspectConversions", fields: [convertedToOrganizationId], references: [id])
  convertedAt               DateTime?
  createdById               String
  createdBy                 User                     @relation("ProspectsCreated", fields: [createdById], references: [id])
  createdAt                 DateTime                 @default(now())
  updatedAt                 DateTime                 @updatedAt
  archivedAt                DateTime?
  contacts                  ProspectContact[]
  campaignRecipients        EmailCampaignRecipient[]

  @@index([createdById])
  @@index([lastCampaignSentAt])
  @@index([archivedAt])
  @@index([convertedToOrganizationId])
}

model ProspectContact {
  id                 String                   @id @default(uuid())
  prospectId         String
  prospect           Prospect                 @relation(fields: [prospectId], references: [id], onDelete: Cascade)
  name               String
  email              String
  phone              String?
  title              String?
  isPrimary          Boolean                  @default(false)
  createdAt          DateTime                 @default(now())
  updatedAt          DateTime                 @updatedAt
  campaignRecipients EmailCampaignRecipient[]

  @@unique([prospectId, email])
  @@index([prospectId])
  @@index([email])
}

model EmailCampaign {
  id           String                   @id @default(uuid())
  name         String
  subject      String
  htmlBody     String                   @db.Text
  textBody     String                   @db.Text
  status       EmailCampaignStatus      @default(draft)
  scheduledFor DateTime?
  sentAt       DateTime?
  createdById  String
  createdBy    User                     @relation("CampaignsCreated", fields: [createdById], references: [id])
  createdAt    DateTime                 @default(now())
  updatedAt    DateTime                 @updatedAt
  recipients   EmailCampaignRecipient[]

  @@index([createdById])
  @@index([status])
  @@index([scheduledFor])
  @@index([sentAt])
}

enum EmailCampaignStatus {
  draft
  scheduled
  sending
  sent
  failed
  cancelled
}

model EmailCampaignRecipient {
  id                 String             @id @default(uuid())
  campaignId         String
  campaign           EmailCampaign      @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  prospectId         String
  prospect           Prospect           @relation(fields: [prospectId], references: [id], onDelete: Cascade)
  prospectContactId  String
  prospectContact    ProspectContact    @relation(fields: [prospectContactId], references: [id], onDelete: Cascade)
  emailLogId         String?            @unique
  emailLog           EmailLog?          @relation(fields: [emailLogId], references: [id])
  status             String             @default("pending")
  sentAt             DateTime?
  deliveredAt        DateTime?
  openedAt           DateTime?
  clickedAt          DateTime?
  bouncedAt          DateTime?
  bounceReason       String?
  repliedAt          DateTime?
  convertedAt        DateTime?
  conversionType     String?
  createdAt          DateTime           @default(now())
  salesOpportunities SalesOpportunity[]

  @@unique([campaignId, prospectContactId])
  @@index([campaignId])
  @@index([prospectId])
  @@index([prospectContactId])
  @@index([status])
  @@index([emailLogId])
}

model OrganizationContract {
  id               String       @id @default(uuid())
  organizationId   String       @unique
  contractStart    DateTime
  contractEnd      DateTime
  renewalDate      DateTime
  amount           Decimal      @db.Decimal(10, 2)
  paymentTerms     String?
  status           String       @default("active")
  lastReminderSent DateTime?
  lastInvoiceSent  DateTime?
  notes            String?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([renewalDate])
  @@index([status])
  @@index([organizationId])
}

model Holiday {
  id          String   @id @default(uuid())
  name        String
  date        DateTime
  isRecurring Boolean  @default(false)
  createdById String?
  createdAt   DateTime @default(now())
  createdBy   User?    @relation("HolidaysCreated", fields: [createdById], references: [id])

  @@index([date])
}

model SupportTicket {
  id                        String             @id @default(uuid())
  title                     String
  description               String
  createdById               String
  assignedToId              String?
  organizationId            String?
  category                  String
  status                    String             @default("open")
  priority                  String             @default("medium")
  workPriorityScore         Float              @default(0)
  tags                      String[]           @default([])
  isEscalated               Boolean            @default(false)
  escalatedAt               DateTime?
  escalatedById             String?
  escalatedFromOrgId        String?
  escalationRejectedAt      DateTime?
  escalationRejectedById    String?
  escalationRejectionReason String?
  slaDeadline               DateTime?
  resolvedAt                DateTime?
  resolvedById              String?
  resolution                String?
  closedAt                  DateTime?
  closedById                String?
  rejectionReason           String?
  aiDetectedPriority        Boolean            @default(false)
  responseSLADeadline       DateTime?
  resolutionSLADeadline     DateTime?
  responseSLAStatus         SLAStatus          @default(on_track)
  resolutionSLAStatus       SLAStatus?         @default(on_track)
  slaPausedAt               DateTime?
  slaPausedReason           String?
  totalPausedMinutes        Int                @default(0)
  actualResponseTime        Int?
  actualResolutionTime      Int?
  responseSLAMet            Boolean?
  resolutionSLAMet          Boolean?
  createdAt                 DateTime           @default(now())
  updatedAt                 DateTime           @updatedAt
  assignedTo                User?              @relation("TicketsAssigned", fields: [assignedToId], references: [id])
  closedBy                  User?              @relation("TicketsClosed", fields: [closedById], references: [id])
  createdBy                 User               @relation("TicketsCreated", fields: [createdById], references: [id])
  organization              Organization?      @relation(fields: [organizationId], references: [id])
  resolvedBy                User?              @relation("TicketsResolved", fields: [resolvedById], references: [id])
  attachments               TicketAttachment[]
  linksFrom                 TicketLink[]       @relation("SourceTicket")
  linksTo                   TicketLink[]       @relation("TargetTicket")
  messages                  TicketMessage[]
  similarityTarget          TicketSimilarity[] @relation("SimilarityTarget")
  similaritySource          TicketSimilarity[] @relation("SimilaritySource")

  @@index([workPriorityScore])
  @@index([status])
  @@index([createdAt])
  @@index([assignedToId])
  @@index([organizationId])
  @@index([priority])
  @@index([responseSLADeadline])
  @@index([resolutionSLADeadline])
  @@index([responseSLAStatus])
  @@index([resolutionSLAStatus])
}

model TicketMessage {
  id          String             @id @default(uuid())
  ticketId    String
  authorId    String
  authorRole  String
  content     String
  isInternal  Boolean            @default(false)
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  attachments TicketAttachment[]
  author      User               @relation("TicketMessagesAuthored", fields: [authorId], references: [id])
  ticket      SupportTicket      @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@index([createdAt])
}

model TicketAttachment {
  id           String         @id @default(uuid())
  ticketId     String
  messageId    String?
  fileName     String
  filePath     String
  fileSize     Int
  mimeType     String
  uploadedById String
  createdAt    DateTime       @default(now())
  message      TicketMessage? @relation(fields: [messageId], references: [id], onDelete: Cascade)
  ticket       SupportTicket  @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  uploadedBy   User           @relation("TicketAttachmentsUploaded", fields: [uploadedById], references: [id])

  @@index([ticketId])
  @@index([messageId])
}

model TicketLink {
  id             String        @id @default(uuid())
  sourceTicketId String
  targetTicketId String
  relationship   String
  aiSuggested    Boolean       @default(false)
  createdById    String
  createdAt      DateTime      @default(now())
  createdBy      User          @relation("TicketLinksCreated", fields: [createdById], references: [id])
  sourceTicket   SupportTicket @relation("SourceTicket", fields: [sourceTicketId], references: [id], onDelete: Cascade)
  targetTicket   SupportTicket @relation("TargetTicket", fields: [targetTicketId], references: [id], onDelete: Cascade)

  @@unique([sourceTicketId, targetTicketId, relationship])
  @@index([sourceTicketId])
  @@index([targetTicketId])
}

model TicketSimilarity {
  id              String        @id @default(uuid())
  sourceTicketId  String
  similarTicketId String
  similarityScore Float
  matchType       String
  analyzedAt      DateTime      @default(now())
  expiresAt       DateTime
  similarTicket   SupportTicket @relation("SimilarityTarget", fields: [similarTicketId], references: [id], onDelete: Cascade)
  sourceTicket    SupportTicket @relation("SimilaritySource", fields: [sourceTicketId], references: [id], onDelete: Cascade)

  @@unique([sourceTicketId, similarTicketId, matchType])
  @@index([sourceTicketId, matchType, expiresAt])
  @@index([expiresAt])
}

model SafetyDetectionFeedback {
  id                  String    @id @default(uuid())
  sessionId           String?
  messageId           String?
  userId              String?
  detectionType       String
  detectionMethod     String
  confidenceLevel     String
  messageContent      String
  isAccurate          Boolean?
  feedbackNote        String?
  detectedAt          DateTime  @default(now())
  feedbackSubmittedAt DateTime?

  @@index([detectionType])
  @@index([detectionMethod])
  @@index([confidenceLevel])
  @@index([isAccurate])
  @@index([detectedAt])
}

model Book {
  id                        String                  @id @default(uuid())
  isbn                      String?
  title                     String
  author                    String
  publisher                 String?
  publicationYear           Int?
  description               String?
  coverImageUrl             String?
  purchaseUrl               String?                 // URL where book can be purchased
  biblicalAlignmentScore    Int?
  evaluationVersion         String
  theologicalSummary        String?
  denominationalTags        String[]                @default([])
  genreTag                  String
  matureContent             Boolean                 @default(false)
  matureContentReason       String?
  scriptureComparisonNotes  String?
  theologicalStrengths      String[]                @default([])
  theologicalConcerns       String[]                @default([])
  scoringReasoning          String?
  aiModel                   String
  pdfStoragePath            String?
  pdfUploadedAt             DateTime?
  pdfFilePath               String?                 // Path to PDF file on disk
  pdfFileSize               Int?                    // File size in bytes
  pdfLicenseType            PdfLicenseType?
  pdfStorageTier            PdfStorageTier?
  pdfFileHash               String?                 // SHA-256 hash for duplicate detection
  pdfMetadataYear           Int?                    // Year extracted from PDF metadata
  createdAt                 DateTime                @default(now())
  updatedAt                 DateTime                @updatedAt
  submittedById             String
  submittedByOrganizationId String
  evaluationStatus          BookEvaluationStatus
  visibilityTier            BookVisibilityTier
  analysisLevel             BookAnalysisLevel
  submittedBy               User                    @relation("BooksSubmitted", fields: [submittedById], references: [id])
  submittedByOrganization   Organization            @relation("BooksSubmittedByOrg", fields: [submittedByOrganizationId], references: [id])
  endorsements              BookEndorsement[]
  evaluationHistory         BookEvaluation[]
  doctrineCategoryScores    DoctrineCategoryScore[]
  purchaseLinks             PurchaseLink[]
  userReadingLists          UserReadingList[]             @relation("UserReadingLists")
  conversationMentions      ConversationResourceMention[] @relation("ConversationMentions")

  @@index([evaluationStatus])
  @@index([visibilityTier])
  @@index([biblicalAlignmentScore])
  @@index([submittedById])
  @@index([submittedByOrganizationId])
  @@index([genreTag])
  @@index([isbn])
  @@index([createdAt])
  @@index([pdfFileHash])
}

model BookEvaluation {
  id            String            @id @default(uuid())
  bookId        String
  version       String
  score         Int
  evaluatedAt   DateTime          @default(now())
  changedFrom   Int?
  aiModel       String
  analysisLevel BookAnalysisLevel
  book          Book              @relation(fields: [bookId], references: [id], onDelete: Cascade)

  @@index([bookId])
  @@index([evaluatedAt])
}

model DoctrineCategoryScore {
  id       String  @id @default(uuid())
  bookId   String
  category String
  score    Int
  notes    String?
  book     Book    @relation(fields: [bookId], references: [id], onDelete: Cascade)

  @@unique([bookId, category])
  @@index([bookId])
  @@index([category])
}

model BookEndorsement {
  id             String       @id @default(uuid())
  bookId         String
  organizationId String
  endorsedAt     DateTime     @default(now())
  endorsedById   String
  book           Book         @relation(fields: [bookId], references: [id], onDelete: Cascade)
  endorsedBy     User         @relation("BookEndorsements", fields: [endorsedById], references: [id])
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([bookId, organizationId])
  @@index([bookId])
  @@index([organizationId])
  @@index([endorsedById])
}

model PurchaseLink {
  id        String  @id @default(uuid())
  bookId    String
  retailer  String
  url       String
  isPrimary Boolean @default(false)
  price     String?
  book      Book    @relation(fields: [bookId], references: [id], onDelete: Cascade)

  @@index([bookId])
}

model SalesOpportunity {
  id                   String                  @id @default(uuid())
  title                String
  description          String
  createdById          String
  assignedToId         String?
  contactName          String
  contactEmail         String
  contactPhone         String?
  companyName          String?
  organizationId       String?
  stage                SalesStage
  leadSource           LeadSource
  dealValue            Decimal                 @db.Decimal(10, 2)
  probability          Int
  priorityScore        Float                   @default(0)
  estimatedCloseDate   DateTime?
  firstContactAt       DateTime?
  proposalSentAt       DateTime?
  negotiationStartedAt DateTime?
  wonAt                DateTime?
  lostAt               DateTime?
  lastActivityAt       DateTime?
  nextFollowUpAt       DateTime?
  followUpNotes        String?
  lossReason           LossReason?
  lossNotes            String?
  campaignRecipientId  String?
  campaignRecipient    EmailCampaignRecipient? @relation(fields: [campaignRecipientId], references: [id])
  createdAt            DateTime                @default(now())
  updatedAt            DateTime                @updatedAt
  activities           SalesActivity[]
  notes                SalesNote[]
  assignedTo           User?                   @relation("OpportunitiesAssigned", fields: [assignedToId], references: [id])
  createdBy            User                    @relation("OpportunitiesCreated", fields: [createdById], references: [id])
  organization         Organization?           @relation(fields: [organizationId], references: [id])

  @@index([stage])
  @@index([leadSource])
  @@index([createdById])
  @@index([assignedToId])
  @@index([organizationId])
  @@index([priorityScore])
  @@index([estimatedCloseDate])
  @@index([createdAt])
  @@index([campaignRecipientId])
}

model SalesActivity {
  id             String           @id @default(uuid())
  opportunityId  String
  performedById  String
  activityType   String
  subject        String
  notes          String?
  duration       Int?
  outcome        String?
  nextFollowUpAt DateTime?
  createdAt      DateTime         @default(now())
  opportunity    SalesOpportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  performedBy    User             @relation("SalesActivitiesPerformed", fields: [performedById], references: [id])

  @@index([opportunityId])
  @@index([performedById])
  @@index([createdAt])
}

model SalesNote {
  id            String           @id @default(uuid())
  opportunityId String
  authorId      String
  content       String
  isPrivate     Boolean          @default(false)
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  author        User             @relation("SalesNotesAuthored", fields: [authorId], references: [id])
  opportunity   SalesOpportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)

  @@index([opportunityId])
  @@index([authorId])
  @@index([createdAt])
}

enum SLAStatus {
  on_track
  approaching
  critical
  breached
}

enum SalesStage {
  prospect
  qualified
  proposal
  negotiation
  won
  lost
}

enum LeadSource {
  email
  website
  referral
  cold_outreach
  event
  partner
}

enum LossReason {
  budget
  timing
  competitor
  no_response
  not_qualified
  other
}

enum BookEvaluationStatus {
  pending
  processing
  completed
  failed
}

enum BookVisibilityTier {
  not_aligned
  conceptually_aligned
  globally_aligned
}

enum BookAnalysisLevel {
  isbn_summary
  pdf_summary
  full_text
}

enum PdfStorageTier {
  active
  archived
}

enum PdfLicenseType {
  public_domain
  creative_commons
  publisher_permission
  analysis_only
}

// Deduplicated address table for organizations
model OrganizationAddress {
  id                     String                 @id @default(uuid())
  street                 String
  city                   String
  state                  String
  zipCode                String
  country                String                 @default("USA")
  latitude               Float?
  longitude              Float?
  // Normalized address for deduplication (e.g., "123 MAIN ST|CITY|STATE|ZIP")
  normalizedAddress      String                 @unique
  createdAt              DateTime               @default(now())
  updatedAt              DateTime               @updatedAt
  organizations          Organization[]
  externalOrganizations  ExternalOrganization[]

  @@index([city, state])
  @@index([zipCode])
}

// External organization referrals (Phase 2 of Biblical Resources)
model ExternalOrganization {
  id                          String                        @id @default(uuid())
  name                        String
  organizationTypes           String[]
  specialtyTags               String[]
  organizationAddressId       String?
  organizationAddress         OrganizationAddress?          @relation(fields: [organizationAddressId], references: [id])
  phone                       String?
  email                       String?
  website                     String?
  hours                       String?
  recommendedByOrganizationId String
  recommendationNote          String
  createdAt                   DateTime                      @default(now())
  updatedAt                   DateTime                      @updatedAt
  addedById                   String
  conversationMentions        ConversationResourceMention[]
  addedBy                     User                          @relation("ExternalOrgsAdded", fields: [addedById], references: [id])
  recommendedBy               Organization                  @relation("ExternalOrgsRecommended", fields: [recommendedByOrganizationId], references: [id], onDelete: Cascade)

  @@index([recommendedByOrganizationId])
  @@index([organizationAddressId])
}

// User reading lists for personal book tracking
model UserReadingList {
  id             String    @id @default(uuid())
  userId         String
  bookId         String
  status         String    // 'want_to_read' | 'currently_reading' | 'finished'
  progress       Int?      // Percentage for currently_reading
  personalNotes  String?   @db.Text
  personalRating Int?      // 1-5 stars
  dateStarted    DateTime?
  dateFinished   DateTime?
  addedAt        DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  book           Book      @relation("UserReadingLists", fields: [bookId], references: [id], onDelete: Cascade)
  user           User      @relation("ReadingLists", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, bookId])
  @@index([userId, status])
}

// Resource mentions in counseling conversations
model ConversationResourceMention {
  id             String                @id @default(uuid())
  conversationId String                // Session ID
  messageId      String?               // Specific message in conversation
  resourceType   String                // 'book' | 'organization'
  bookId         String?
  externalOrgId  String?
  contextSnippet String?               @db.Text
  mentionedAt    DateTime              @default(now())
  book           Book?                 @relation("ConversationMentions", fields: [bookId], references: [id], onDelete: Cascade)
  externalOrg    ExternalOrganization? @relation(fields: [externalOrgId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([bookId])
  @@index([externalOrgId])
}
