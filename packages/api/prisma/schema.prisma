generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                                                   String                   @id @default(uuid())
  email                                                String                   @unique
  passwordHash                                         String
  firstName                                            String?
  lastName                                             String?
  emailVerified                                        Boolean                  @default(false)
  verificationToken                                    String?                  @unique
  resetToken                                           String?                  @unique
  resetTokenExpiry                                     DateTime?
  isActive                                             Boolean                  @default(true)
  createdAt                                            DateTime                 @default(now())
  updatedAt                                            DateTime                 @updatedAt
  accountType                                          String                   @default("individual")
  isPlatformAdmin                                      Boolean                  @default(false)
  comparisonTranslations                               String[]                 @default(["ESV", "NASB", "NIV", "NKJV"])
  preferredTranslation                                 String?                  @default("KJV")
  stripeCustomerId                                     String?                  @unique
  subscriptionEnd                                      DateTime?
  subscriptionStart                                    DateTime?
  subscriptionStatus                                   String                   @default("none")
  subscriptionTier                                     String?
  birthDate                                            DateTime?
  city                                                 String?
  state                                                String?
  zipCode                                              String?
  adminActionsGiven                                    AdminAuditLog[]          @relation("AdminActions")
  adminActionsReceived                                 AdminAuditLog[]          @relation("ActionsReceived")
  submittedBooks                                       Book[]                   @relation("BookSubmitter")
  bookEndorsements                                     BookEndorsement[]
  counselorAssignments                                 CounselorAssignment[]    @relation("CounselorAssignments")
  memberAssignments                                    CounselorAssignment[]    @relation("MemberAssignments")
  coverageGrantsReceived                               CounselorCoverageGrant[] @relation("CoverageGrantsReceived")
  coverageGrantsForMember                              CounselorCoverageGrant[] @relation("CoverageGrantsForMember")
  coverageGrantsGiven                                  CounselorCoverageGrant[] @relation("CoverageGrantsGiven")
  observationsAuthored                                 CounselorObservation[]   @relation("ObservationsAuthored")
  observationsReceived                                 CounselorObservation[]   @relation("ObservationsReceived")
  externalOrgsAdded                                    ExternalOrganization[]
  holidaysCreated                                      Holiday[]                @relation("HolidaysCreated")
  wellbeingStatus                                      MemberWellbeingStatus?
  notificationsReceived                                Notification[]           @relation("NotificationsReceived")
  notificationsSent                                    Notification[]           @relation("NotificationsSent")
  invitationsReceived                                  OrganizationInvitation[] @relation("InvitedUser")
  invitationsCreated                                   OrganizationInvitation[] @relation("CreatedByUser")
  organizationMemberships                              OrganizationMember[]
  refreshTokens                                        RefreshToken[]
  SalesNote                                            SalesNote[]
  SalesOpportunity_SalesOpportunity_assignedToIdToUser SalesOpportunity[]       @relation("SalesOpportunity_assignedToIdToUser")
  SalesOpportunity_SalesOpportunity_createdByIdToUser  SalesOpportunity[]       @relation("SalesOpportunity_createdByIdToUser")
  sessions                                             Session[]
  sessionNotesAuthored                                 SessionNote[]            @relation("SessionNotesAuthored")
  subscriptions                                        Subscription[]
  SupportTicket_SupportTicket_assignedToIdToUser       SupportTicket[]          @relation("SupportTicket_assignedToIdToUser")
  SupportTicket_SupportTicket_closedByIdToUser         SupportTicket[]          @relation("SupportTicket_closedByIdToUser")
  SupportTicket_SupportTicket_createdByIdToUser        SupportTicket[]          @relation("SupportTicket_createdByIdToUser")
  SupportTicket_SupportTicket_resolvedByIdToUser       SupportTicket[]          @relation("SupportTicket_resolvedByIdToUser")
  TicketAttachment                                     TicketAttachment[]
  TicketLink                                           TicketLink[]
  TicketMessage                                        TicketMessage[]
  readingList                                          UserReadingList[]

  @@index([email])
  @@index([verificationToken])
  @@index([resetToken])
  @@index([accountType])
  @@index([isPlatformAdmin])
  @@index([subscriptionStatus])
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  ipAddress String?
  userAgent String?
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@index([createdAt])
}

model Organization {
  id                                String                   @id @default(uuid())
  name                              String
  description                       String?
  licenseType                       String?
  licenseStatus                     String                   @default("trial")
  licenseExpiresAt                  DateTime?
  maxMembers                        Int                      @default(10)
  createdAt                         DateTime                 @default(now())
  updatedAt                         DateTime                 @updatedAt
  isSystemOrganization              Boolean                  @default(false)
  address                           String?
  archivedAt                        DateTime?
  city                              String?
  country                           String?
  latitude                          Float?
  longitude                         Float?
  matureContentAccountTypeThreshold String                   @default("teen")
  offersVirtualServices             Boolean                  @default(false)
  organizationTypes                 String[]
  specialtyTags                     String[]
  state                             String?
  zipCode                           String?
  auditLogs                         AdminAuditLog[]
  submittedBooks                    Book[]                   @relation("BookSubmittingOrg")
  bookEndorsements                  BookEndorsement[]
  counselorAssignments              CounselorAssignment[]
  externalOrgRecommendations        ExternalOrganization[]
  metricSnapshots                   MetricSnapshot[]
  contract                          OrganizationContract?
  invitations                       OrganizationInvitation[]
  members                           OrganizationMember[]
  roles                             OrganizationRole[]
  SalesOpportunity                  SalesOpportunity[]
  SupportTicket                     SupportTicket[]

  @@index([licenseStatus])
  @@index([licenseExpiresAt])
  @@index([isSystemOrganization])
}

model OrganizationMember {
  id             String           @id @default(uuid())
  organizationId String
  userId         String
  roleId         String
  joinedAt       DateTime         @default(now())
  organization   Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  role           OrganizationRole @relation(fields: [roleId], references: [id])
  user           User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@index([organizationId])
  @@index([userId])
}

model OrganizationRole {
  id             String               @id @default(uuid())
  organizationId String
  name           String
  description    String?
  isSystemRole   Boolean              @default(false)
  permissions    Json                 @default("[]")
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt
  members        OrganizationMember[]
  organization   Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, name])
  @@index([organizationId])
}

model OrganizationInvitation {
  id             String       @id @default(uuid())
  organizationId String
  email          String
  roleId         String
  invitedById    String
  token          String       @unique
  status         String       @default("pending")
  expiresAt      DateTime
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  acceptedById   String?
  acceptedBy     User?        @relation("InvitedUser", fields: [acceptedById], references: [id])
  invitedBy      User         @relation("CreatedByUser", fields: [invitedById], references: [id], onDelete: Cascade)
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([email])
  @@index([token])
  @@index([status])
  @@index([expiresAt])
}

model AdminAuditLog {
  id             String        @id @default(uuid())
  adminUserId    String
  action         String
  targetUserId   String?
  targetOrgId    String?
  morphSessionId String?
  metadata       Json          @default("{}")
  createdAt      DateTime      @default(now())
  adminUser      User          @relation("AdminActions", fields: [adminUserId], references: [id])
  targetOrg      Organization? @relation(fields: [targetOrgId], references: [id])
  targetUser     User?         @relation("ActionsReceived", fields: [targetUserId], references: [id])

  @@index([adminUserId])
  @@index([morphSessionId])
  @@index([action])
  @@index([createdAt])
}

model MetricSnapshot {
  id             String        @id @default(uuid())
  snapshotType   String
  snapshotDate   DateTime
  organizationId String?
  metrics        Json
  createdAt      DateTime      @default(now())
  organization   Organization? @relation(fields: [organizationId], references: [id])

  @@unique([snapshotType, snapshotDate, organizationId])
  @@index([snapshotDate])
  @@index([organizationId])
}

model Session {
  id                   String         @id @default(uuid())
  userId               String?
  title                String
  status               String         @default("active")
  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt
  preferredTranslation String         @default("ASV")
  topics               Json           @default("[]")
  archivedAt           DateTime?
  deletedAt            DateTime?
  questionCount        Int            @default(0)
  messages             Message[]
  user                 User?          @relation(fields: [userId], references: [id])
  notes                SessionNote[]
  shares               SessionShare[]

  @@index([createdAt])
  @@index([userId])
  @@index([status])
}

model Message {
  id                       String   @id @default(uuid())
  sessionId                String
  role                     String
  content                  String
  scriptureReferences      Json     @default("[]")
  constitutionalReferences Json     @default("[]")
  timestamp                DateTime @default(now())
  isClarifyingQuestion     Boolean  @default(false)
  session                  Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([timestamp])
}

model SessionNote {
  id         String    @id @default(uuid())
  sessionId  String
  authorId   String
  authorName String
  authorRole String
  content    String
  isPrivate  Boolean   @default(false)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  deletedAt  DateTime?
  author     User      @relation("SessionNotesAuthored", fields: [authorId], references: [id], onDelete: Cascade)
  session    Session   @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([authorId])
  @@index([createdAt])
  @@index([deletedAt])
}

model BibleTranslation {
  code        String       @id @unique
  name        String
  fullName    String
  description String?
  isActive    Boolean      @default(true)
  createdAt   DateTime     @default(now())
  verses      BibleVerse[]

  @@index([isActive])
}

model BibleVerse {
  id              String           @id @default(uuid())
  translationCode String
  book            String
  chapter         Int
  verse           Int
  text            String
  strongs         Json?            @default("[]")
  translation     BibleTranslation @relation(fields: [translationCode], references: [code], onDelete: Cascade)

  @@unique([translationCode, book, chapter, verse])
  @@index([translationCode, book, chapter, verse])
  @@index([book])
}

model Subscription {
  id                   String    @id @default(uuid())
  userId               String
  status               String
  tier                 String    @default("basic")
  startDate            DateTime  @default(now())
  endDate              DateTime?
  stripeSubscriptionId String?   @unique
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  user                 User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
}

model SessionShare {
  id               String               @id @default(uuid())
  sessionId        String
  shareToken       String               @unique
  sharedBy         String
  sharedWith       String?
  organizationId   String?
  createdAt        DateTime             @default(now())
  expiresAt        DateTime?
  allowNotesAccess Boolean              @default(false)
  session          Session              @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  accesses         SessionShareAccess[]

  @@index([sessionId])
  @@index([shareToken])
}

model SessionShareAccess {
  id              String       @id @default(uuid())
  shareId         String
  userId          String
  firstAccessedAt DateTime     @default(now())
  lastAccessedAt  DateTime     @default(now())
  isDismissed     Boolean      @default(false)
  dismissedAt     DateTime?
  share           SessionShare @relation(fields: [shareId], references: [id], onDelete: Cascade)

  @@unique([shareId, userId])
  @@index([userId])
  @@index([shareId])
  @@index([isDismissed])
}

model CounselorAssignment {
  id             String       @id @default(uuid())
  counselorId    String
  memberId       String
  organizationId String
  status         String       @default("active")
  assignedBy     String
  assignedAt     DateTime     @default(now())
  endedAt        DateTime?
  counselor      User         @relation("CounselorAssignments", fields: [counselorId], references: [id], onDelete: Cascade)
  member         User         @relation("MemberAssignments", fields: [memberId], references: [id], onDelete: Cascade)
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([counselorId, memberId, organizationId])
  @@index([counselorId, status])
  @@index([memberId])
  @@index([organizationId])
}

model CounselorObservation {
  id          String    @id @default(uuid())
  counselorId String
  memberId    String
  content     String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  counselor   User      @relation("ObservationsAuthored", fields: [counselorId], references: [id], onDelete: Cascade)
  member      User      @relation("ObservationsReceived", fields: [memberId], references: [id], onDelete: Cascade)

  @@index([counselorId, memberId])
  @@index([createdAt])
  @@index([deletedAt])
}

model CounselorCoverageGrant {
  id                 String    @id @default(uuid())
  primaryCounselorId String
  backupCounselorId  String
  memberId           String
  grantedAt          DateTime  @default(now())
  expiresAt          DateTime?
  revokedAt          DateTime?
  backupCounselor    User      @relation("CoverageGrantsReceived", fields: [backupCounselorId], references: [id], onDelete: Cascade)
  member             User      @relation("CoverageGrantsForMember", fields: [memberId], references: [id], onDelete: Cascade)
  primaryCounselor   User      @relation("CoverageGrantsGiven", fields: [primaryCounselorId], references: [id], onDelete: Cascade)

  @@index([backupCounselorId, revokedAt])
  @@index([primaryCounselorId])
  @@index([memberId])
}

model MemberWellbeingStatus {
  id                String   @id @default(uuid())
  memberId          String   @unique
  status            String
  aiSuggestedStatus String
  overriddenBy      String?
  summary           String
  lastAnalyzedAt    DateTime @default(now())
  updatedAt         DateTime @updatedAt
  member            User     @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([lastAnalyzedAt])
}

model Notification {
  id          String    @id @default(uuid())
  recipientId String
  senderId    String?
  type        String
  category    String
  title       String
  message     String
  linkTo      String?
  isRead      Boolean   @default(false)
  isDismissed Boolean   @default(false)
  createdAt   DateTime  @default(now())
  expiresAt   DateTime?
  recipient   User      @relation("NotificationsReceived", fields: [recipientId], references: [id], onDelete: Cascade)
  sender      User?     @relation("NotificationsSent", fields: [senderId], references: [id], onDelete: Cascade)

  @@index([recipientId, isRead, isDismissed])
  @@index([createdAt])
  @@index([recipientId, createdAt])
}

model EmailLog {
  id             String    @id @default(uuid())
  userId         String?
  recipientEmail String
  emailType      String
  postmarkId     String?   @unique
  status         String
  bounceReason   String?
  metadata       Json      @default("{}")
  sentAt         DateTime  @default(now())
  deliveredAt    DateTime?
  openedAt       DateTime?
  clickedAt      DateTime?
  bouncedAt      DateTime?

  @@index([userId])
  @@index([recipientEmail])
  @@index([emailType])
  @@index([status])
  @@index([sentAt])
  @@index([postmarkId])
}

model EmailRateLimit {
  id             String   @id @default(uuid())
  identifier     String
  identifierType String
  operation      String
  attemptCount   Int      @default(1)
  windowStart    DateTime @default(now())
  expiresAt      DateTime

  @@unique([identifier, identifierType, operation])
  @@index([identifier, operation])
  @@index([expiresAt])
}

model OrganizationContract {
  id               String       @id @default(uuid())
  organizationId   String       @unique
  contractStart    DateTime
  contractEnd      DateTime
  renewalDate      DateTime
  amount           Decimal      @db.Decimal(10, 2)
  paymentTerms     String?
  status           String       @default("active")
  lastReminderSent DateTime?
  lastInvoiceSent  DateTime?
  notes            String?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([renewalDate])
  @@index([status])
  @@index([organizationId])
}

model Holiday {
  id          String   @id @default(uuid())
  name        String
  date        DateTime
  isRecurring Boolean  @default(false)
  createdById String
  createdAt   DateTime @default(now())
  createdBy   User     @relation("HolidaysCreated", fields: [createdById], references: [id])

  @@unique([name, date])
  @@index([date])
}

model Book {
  id                        String                        @id @default(uuid())
  isbn                      String?                       @unique
  title                     String
  author                    String
  publisher                 String?
  publicationYear           Int?
  description               String?
  coverImageUrl             String?
  evaluationStatus          String                        @default("pending")
  biblicalAlignmentScore    Int?
  visibilityTier            String?
  evaluationVersion         String?
  theologicalSummary        String?
  denominationalTags        String[]
  genreTag                  String?
  matureContent             Boolean                       @default(false)
  matureContentReason       String?
  scriptureComparisonNotes  String?
  theologicalStrengths      String[]
  theologicalConcerns       String[]
  scoringReasoning          String?
  analysisLevel             String?
  aiModel                   String?
  pdfStoragePath            String?
  pdfStorageTier            String?
  pdfLicenseType            String?
  pdfUploadedAt             DateTime?
  createdAt                 DateTime                      @default(now())
  updatedAt                 DateTime                      @updatedAt
  submittedById             String
  submittedByOrganizationId String
  submittedBy               User                          @relation("BookSubmitter", fields: [submittedById], references: [id])
  submittedByOrganization   Organization                  @relation("BookSubmittingOrg", fields: [submittedByOrganizationId], references: [id])
  endorsements              BookEndorsement[]
  conversationMentions      ConversationResourceMention[]
  doctrineCategoryScores    DoctrineCategoryScore[]
  evaluationHistory         EvaluationRecord[]
  purchaseLinks             PurchaseLink[]
  userReadingLists          UserReadingList[]

  @@index([biblicalAlignmentScore])
  @@index([visibilityTier])
  @@index([evaluationStatus])
}

model EvaluationRecord {
  id            String   @id @default(uuid())
  bookId        String
  version       String
  score         Int
  changedFrom   Int?
  evaluatedAt   DateTime @default(now())
  aiModel       String
  analysisLevel String
  book          Book     @relation(fields: [bookId], references: [id], onDelete: Cascade)

  @@index([bookId])
}

model DoctrineCategoryScore {
  id       String  @id @default(uuid())
  bookId   String
  category String
  score    Int
  notes    String?
  book     Book    @relation(fields: [bookId], references: [id], onDelete: Cascade)

  @@unique([bookId, category])
}

model PurchaseLink {
  id        String  @id @default(uuid())
  bookId    String
  retailer  String
  url       String
  isPrimary Boolean @default(false)
  book      Book    @relation(fields: [bookId], references: [id], onDelete: Cascade)
}

model BookEndorsement {
  id             String       @id @default(uuid())
  bookId         String
  organizationId String
  endorsedAt     DateTime     @default(now())
  endorsedById   String
  book           Book         @relation(fields: [bookId], references: [id], onDelete: Cascade)
  endorsedBy     User         @relation(fields: [endorsedById], references: [id])
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([bookId, organizationId])
}

model UserReadingList {
  id             String    @id @default(uuid())
  userId         String
  bookId         String
  status         String
  progress       Int?
  personalNotes  String?
  personalRating Int?
  dateStarted    DateTime?
  dateFinished   DateTime?
  addedAt        DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  book           Book      @relation(fields: [bookId], references: [id], onDelete: Cascade)
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, bookId])
  @@index([userId, status])
}

model ExternalOrganization {
  id                          String                        @id @default(uuid())
  name                        String
  organizationTypes           String[]
  specialtyTags               String[]
  address                     String
  city                        String
  state                       String
  zipCode                     String
  country                     String
  latitude                    Float?
  longitude                   Float?
  phone                       String?
  email                       String?
  website                     String?
  hours                       String?
  recommendedByOrganizationId String
  recommendationNote          String
  createdAt                   DateTime                      @default(now())
  updatedAt                   DateTime                      @updatedAt
  addedById                   String
  conversationMentions        ConversationResourceMention[]
  addedBy                     User                          @relation(fields: [addedById], references: [id])
  recommendedBy               Organization                  @relation(fields: [recommendedByOrganizationId], references: [id], onDelete: Cascade)

  @@index([recommendedByOrganizationId])
  @@index([city, state])
}

model ConversationResourceMention {
  id             String                @id @default(uuid())
  conversationId String
  messageId      String?
  resourceType   String
  bookId         String?
  externalOrgId  String?
  contextSnippet String?
  mentionedAt    DateTime              @default(now())
  book           Book?                 @relation(fields: [bookId], references: [id], onDelete: Cascade)
  externalOrg    ExternalOrganization? @relation(fields: [externalOrgId], references: [id], onDelete: Cascade)

  @@index([conversationId])
}

model SafetyDetectionFeedback {
  id                  String    @id
  sessionId           String?
  messageId           String?
  userId              String?
  detectionType       String
  detectionMethod     String
  confidenceLevel     String
  messageContent      String
  isAccurate          Boolean?
  feedbackNote        String?
  detectedAt          DateTime  @default(now())
  feedbackSubmittedAt DateTime?

  @@index([confidenceLevel])
  @@index([detectedAt])
  @@index([detectionMethod])
  @@index([detectionType])
  @@index([isAccurate])
}

model SalesNote {
  id               String           @id
  opportunityId    String
  authorId         String
  content          String
  isPrivate        Boolean          @default(false)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime
  User             User             @relation(fields: [authorId], references: [id])
  SalesOpportunity SalesOpportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)

  @@index([authorId])
  @@index([createdAt])
  @@index([opportunityId])
}

model SalesOpportunity {
  id                                       String        @id
  title                                    String
  description                              String
  createdById                              String
  assignedToId                             String?
  contactName                              String
  contactEmail                             String
  contactPhone                             String?
  companyName                              String?
  organizationId                           String?
  stage                                    SalesStage
  leadSource                               LeadSource
  dealValue                                Decimal       @db.Decimal(10, 2)
  probability                              Int
  priorityScore                            Float         @default(0)
  estimatedCloseDate                       DateTime?
  firstContactAt                           DateTime?
  proposalSentAt                           DateTime?
  negotiationStartedAt                     DateTime?
  wonAt                                    DateTime?
  lostAt                                   DateTime?
  lastActivityAt                           DateTime?
  nextFollowUpAt                           DateTime?
  followUpNotes                            String?
  lossReason                               LossReason?
  lossNotes                                String?
  createdAt                                DateTime      @default(now())
  updatedAt                                DateTime
  SalesNote                                SalesNote[]
  User_SalesOpportunity_assignedToIdToUser User?         @relation("SalesOpportunity_assignedToIdToUser", fields: [assignedToId], references: [id])
  User_SalesOpportunity_createdByIdToUser  User          @relation("SalesOpportunity_createdByIdToUser", fields: [createdById], references: [id])
  Organization                             Organization? @relation(fields: [organizationId], references: [id])

  @@index([assignedToId])
  @@index([createdAt])
  @@index([createdById])
  @@index([estimatedCloseDate])
  @@index([leadSource])
  @@index([organizationId])
  @@index([priorityScore])
  @@index([stage])
}

model SupportTicket {
  id                                                               String             @id
  title                                                            String
  description                                                      String
  createdById                                                      String
  assignedToId                                                     String?
  organizationId                                                   String?
  category                                                         String
  status                                                           String             @default("open")
  priority                                                         String             @default("medium")
  workPriorityScore                                                Float              @default(0)
  tags                                                             String[]           @default([])
  isEscalated                                                      Boolean            @default(false)
  escalatedAt                                                      DateTime?
  escalatedById                                                    String?
  escalatedFromOrgId                                               String?
  escalationRejectedAt                                             DateTime?
  escalationRejectedById                                           String?
  escalationRejectionReason                                        String?
  slaDeadline                                                      DateTime?
  resolvedAt                                                       DateTime?
  resolvedById                                                     String?
  resolution                                                       String?
  closedAt                                                         DateTime?
  closedById                                                       String?
  rejectionReason                                                  String?
  aiDetectedPriority                                               Boolean            @default(false)
  responseSLADeadline                                              DateTime?
  resolutionSLADeadline                                            DateTime?
  responseSLAStatus                                                SLAStatus          @default(on_track)
  resolutionSLAStatus                                              SLAStatus?         @default(on_track)
  slaPausedAt                                                      DateTime?
  slaPausedReason                                                  String?
  totalPausedMinutes                                               Int                @default(0)
  actualResponseTime                                               Int?
  actualResolutionTime                                             Int?
  responseSLAMet                                                   Boolean?
  resolutionSLAMet                                                 Boolean?
  createdAt                                                        DateTime           @default(now())
  updatedAt                                                        DateTime
  User_SupportTicket_assignedToIdToUser                            User?              @relation("SupportTicket_assignedToIdToUser", fields: [assignedToId], references: [id])
  User_SupportTicket_closedByIdToUser                              User?              @relation("SupportTicket_closedByIdToUser", fields: [closedById], references: [id])
  User_SupportTicket_createdByIdToUser                             User               @relation("SupportTicket_createdByIdToUser", fields: [createdById], references: [id])
  Organization                                                     Organization?      @relation(fields: [organizationId], references: [id])
  User_SupportTicket_resolvedByIdToUser                            User?              @relation("SupportTicket_resolvedByIdToUser", fields: [resolvedById], references: [id])
  TicketAttachment                                                 TicketAttachment[]
  TicketLink_TicketLink_sourceTicketIdToSupportTicket              TicketLink[]       @relation("TicketLink_sourceTicketIdToSupportTicket")
  TicketLink_TicketLink_targetTicketIdToSupportTicket              TicketLink[]       @relation("TicketLink_targetTicketIdToSupportTicket")
  TicketMessage                                                    TicketMessage[]
  TicketSimilarity_TicketSimilarity_similarTicketIdToSupportTicket TicketSimilarity[] @relation("TicketSimilarity_similarTicketIdToSupportTicket")
  TicketSimilarity_TicketSimilarity_sourceTicketIdToSupportTicket  TicketSimilarity[] @relation("TicketSimilarity_sourceTicketIdToSupportTicket")

  @@index([assignedToId])
  @@index([createdAt])
  @@index([organizationId])
  @@index([priority])
  @@index([resolutionSLADeadline])
  @@index([resolutionSLAStatus])
  @@index([responseSLADeadline])
  @@index([responseSLAStatus])
  @@index([status])
  @@index([workPriorityScore])
}

model TicketAttachment {
  id            String         @id
  ticketId      String
  messageId     String?
  fileName      String
  filePath      String
  fileSize      Int
  mimeType      String
  uploadedById  String
  createdAt     DateTime       @default(now())
  TicketMessage TicketMessage? @relation(fields: [messageId], references: [id], onDelete: Cascade)
  SupportTicket SupportTicket  @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  User          User           @relation(fields: [uploadedById], references: [id])

  @@index([messageId])
  @@index([ticketId])
}

model TicketLink {
  id                                                     String        @id
  sourceTicketId                                         String
  targetTicketId                                         String
  relationship                                           String
  aiSuggested                                            Boolean       @default(false)
  createdById                                            String
  createdAt                                              DateTime      @default(now())
  User                                                   User          @relation(fields: [createdById], references: [id])
  SupportTicket_TicketLink_sourceTicketIdToSupportTicket SupportTicket @relation("TicketLink_sourceTicketIdToSupportTicket", fields: [sourceTicketId], references: [id], onDelete: Cascade)
  SupportTicket_TicketLink_targetTicketIdToSupportTicket SupportTicket @relation("TicketLink_targetTicketIdToSupportTicket", fields: [targetTicketId], references: [id], onDelete: Cascade)

  @@unique([sourceTicketId, targetTicketId, relationship])
  @@index([sourceTicketId])
  @@index([targetTicketId])
}

model TicketMessage {
  id               String             @id
  ticketId         String
  authorId         String
  authorRole       String
  content          String
  isInternal       Boolean            @default(false)
  createdAt        DateTime           @default(now())
  updatedAt        DateTime
  TicketAttachment TicketAttachment[]
  User             User               @relation(fields: [authorId], references: [id])
  SupportTicket    SupportTicket      @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([ticketId])
}

model TicketSimilarity {
  id                                                            String        @id
  sourceTicketId                                                String
  similarTicketId                                               String
  similarityScore                                               Float
  matchType                                                     String
  analyzedAt                                                    DateTime      @default(now())
  expiresAt                                                     DateTime
  SupportTicket_TicketSimilarity_similarTicketIdToSupportTicket SupportTicket @relation("TicketSimilarity_similarTicketIdToSupportTicket", fields: [similarTicketId], references: [id], onDelete: Cascade)
  SupportTicket_TicketSimilarity_sourceTicketIdToSupportTicket  SupportTicket @relation("TicketSimilarity_sourceTicketIdToSupportTicket", fields: [sourceTicketId], references: [id], onDelete: Cascade)

  @@unique([sourceTicketId, similarTicketId, matchType])
  @@index([expiresAt])
  @@index([sourceTicketId, matchType, expiresAt])
}

enum LeadSource {
  email
  website
  referral
  cold_outreach
  event
  partner
}

enum LossReason {
  budget
  timing
  competitor
  no_response
  not_qualified
  other
}

enum SLAStatus {
  on_track
  approaching
  critical
  breached
}

enum SalesStage {
  prospect
  qualified
  proposal
  negotiation
  won
  lost
}
